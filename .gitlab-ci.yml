# GitLab CI/CD Pipeline Configuration
# Équivalent à GitHub Actions pour comparaison

variables:
  NODE_VERSION: "20"
  FF_USE_LEGACY_KUBERNETES_EXECUTION_STRATEGY: "true"

stages:
  - lint
  - test
  - build
  - e2e
  # - docker  # Désactivé car Docker-in-Docker n'est pas disponible sur ce runner
  - deploy

# ============================================
# BACKEND LINT
# ============================================

backend-lint:
  stage: lint
  image: node:${NODE_VERSION}
  cache:
    key: backend-npm-cache
    paths:
      - backend/node_modules/
  before_script:
    - cd backend
    - npm ci
  script:
    - npm run lint || echo "No lint script, skipping..."
  only:
    - main
    - develop
    - merge_requests
    - /^feature\/.*$/

# ============================================
# FRONTEND LINT
# ============================================

frontend-lint:
  stage: lint
  image: node:${NODE_VERSION}
  cache:
    key: frontend-npm-cache
    paths:
      - frontend/node_modules/
  before_script:
    - cd frontend
    - npm ci
  script:
    - npm run lint
  only:
    - main
    - develop
    - merge_requests
    - /^feature\/.*$/

# ============================================
# BACKEND TESTS
# ============================================

backend-test:
  stage: test
  image: node:${NODE_VERSION}
  cache:
    key: backend-npm-cache
    paths:
      - backend/node_modules/
  before_script:
    - cd backend
    - npm ci
  script:
    - npm test
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    paths:
      - backend/coverage/
    expire_in: 7 days
  only:
    - main
    - develop
    - merge_requests
    - /^feature\/.*$/

# ============================================
# FRONTEND TESTS
# ============================================

frontend-test:
  stage: test
  image: node:${NODE_VERSION}
  cache:
    key: frontend-npm-cache
    paths:
      - frontend/node_modules/
  before_script:
    - cd frontend
    - npm ci
  script:
    - npm test
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    paths:
      - frontend/coverage/
    expire_in: 7 days
  only:
    - main
    - develop
    - merge_requests
    - /^feature\/.*$/

# ============================================
# BUILD FRONTEND
# ============================================

build-frontend:
  stage: build
  image: node:${NODE_VERSION}
  cache:
    key: frontend-npm-cache
    paths:
      - frontend/node_modules/
  dependencies:
    - backend-test
    - frontend-test
  before_script:
    - cd frontend
    - npm ci
  script:
    - npm run build
  artifacts:
    paths:
      - frontend/dist/
    expire_in: 7 days
  only:
    - main
    - develop
    - merge_requests
    - /^feature\/.*$/

# ============================================
# E2E TESTS
# ============================================

e2e-tests:
  stage: e2e
  image: node:${NODE_VERSION}
  dependencies:
    - build-frontend
  before_script:
    - npm ci
    - cd backend && npm ci
    - cd ../frontend && npm ci
    - cd ..
    - npx playwright install --with-deps chromium firefox webkit
  script:
    - cd backend && npm start &
    - export BACKEND_PID=$!
    - cd frontend && npm run dev &
    - export FRONTEND_PID=$!
    - |
      echo "Waiting for backend server..."
      timeout 60 bash -c 'until curl -f http://localhost:3000/api/health; do sleep 2; done'
      echo "Waiting for frontend server..."
      timeout 60 bash -c 'until curl -f http://localhost:5173; do sleep 2; done'
    - npm run test:e2e
    - kill $BACKEND_PID || true
    - kill $FRONTEND_PID || true
  environment:
    name: test
    url: http://localhost:5173
  artifacts:
    when: always
    paths:
      - playwright-report/
    expire_in: 7 days
  only:
    - main
    - develop
    - merge_requests
    - /^feature\/.*$/

# ============================================
# DOCKER BUILD
# ============================================
# NOTE: Docker-in-Docker jobs désactivés car le runner GitLab n'est pas configuré pour DinD
# Ces jobs peuvent être réactivés si un runner avec Docker-in-Docker est disponible
# Pour la comparaison CI/CD, ces jobs ne sont pas essentiels

# docker-build-backend:
#   stage: docker
#   image: docker:24
#   services:
#     - docker:24-dind
#   dependencies:
#     - e2e-tests
#   variables:
#     DOCKER_HOST: tcp://docker:2375
#     DOCKER_TLS_CERTDIR: ""
#     DOCKER_DRIVER: overlay2
#   before_script:
#     - apk add --no-cache curl
#     - |
#       echo "Waiting for Docker daemon..."
#       timeout 30 sh -c 'until docker info; do sleep 1; done' || true
#     - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY || echo "Docker login skipped"
#   script:
#     - |
#       if [ -n "$CI_REGISTRY_USER" ]; then
#         docker build -t $CI_REGISTRY_USER/bmi-app-backend:latest -t $CI_REGISTRY_USER/bmi-app-backend:$CI_COMMIT_SHA ./backend
#         docker push $CI_REGISTRY_USER/bmi-app-backend:latest || echo "Push skipped"
#         docker push $CI_REGISTRY_USER/bmi-app-backend:$CI_COMMIT_SHA || echo "Push skipped"
#       else
#         docker build -t bmi-app-backend:latest -t bmi-app-backend:$CI_COMMIT_SHA ./backend
#       fi
#   allow_failure: true
#   only:
#     - main
#     - develop

# docker-build-frontend:
#   stage: docker
#   image: docker:24
#   services:
#     - docker:24-dind
#   dependencies:
#     - e2e-tests
#   variables:
#     DOCKER_HOST: tcp://docker:2375
#     DOCKER_TLS_CERTDIR: ""
#     DOCKER_DRIVER: overlay2
#   before_script:
#     - apk add --no-cache curl
#     - |
#       echo "Waiting for Docker daemon..."
#       timeout 30 sh -c 'until docker info; do sleep 1; done' || true
#     - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY || echo "Docker login skipped"
#   script:
#     - |
#       if [ -n "$CI_REGISTRY_USER" ]; then
#         docker build -t $CI_REGISTRY_USER/bmi-app-frontend:latest -t $CI_REGISTRY_USER/bmi-app-frontend:$CI_COMMIT_SHA ./frontend
#         docker push $CI_REGISTRY_USER/bmi-app-frontend:latest || echo "Push skipped"
#         docker push $CI_REGISTRY_USER/bmi-app-frontend:$CI_COMMIT_SHA || echo "Push skipped"
#       else
#         docker build -t bmi-app-frontend:latest -t bmi-app-frontend:$CI_COMMIT_SHA ./frontend
#       fi
#   allow_failure: true
#   only:
#     - main
#     - develop

# ============================================
# DEPLOY
# ============================================

deploy-staging:
  stage: deploy
  image: alpine:latest
  dependencies:
    - e2e-tests
  script:
    - |
      echo "Deploying to staging..."
      echo "Add your deployment commands here"
      echo "Example: kubectl apply -f k8s/staging/"
      echo "Or: docker-compose -f docker-compose.staging.yml up -d"
      echo "Note: Deployment is simulated for CI/CD comparison purposes"
  environment:
    name: staging
    url: https://staging.bmi-app.example.com
  only:
    - develop
  when: manual

deploy-production:
  stage: deploy
  image: alpine:latest
  dependencies:
    - e2e-tests
  script:
    - |
      echo "Deploying to production..."
      echo "Add your deployment commands here"
      echo "Example: kubectl apply -f k8s/production/"
      echo "Or: docker-compose -f docker-compose.prod.yml up -d"
      echo "Note: Deployment is simulated for CI/CD comparison purposes"
  environment:
    name: production
    url: https://bmi-app.example.com
  only:
    - main
  when: manual
