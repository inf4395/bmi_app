# GitLab CI/CD Pipeline Configuration
# Ã‰quivalent Ã  GitHub Actions pour comparaison

variables:
  NODE_VERSION: "20"
  FF_USE_LEGACY_KUBERNETES_EXECUTION_STRATEGY: "true"

stages:
  - lint
  - test
  - build
  - e2e
  - docker
  - deploy

# ============================================
# BACKEND LINT
# ============================================

backend-lint:
  stage: lint
  image: node:${NODE_VERSION}
  cache:
    key: backend-npm-cache
    paths:
      - backend/node_modules/
  before_script:
    - cd backend
    - npm ci
  script:
    - npm run lint || echo "No lint script, skipping..."
  only:
    - main
    - develop
    - merge_requests
    - /^feature\/.*$/

# ============================================
# FRONTEND LINT
# ============================================

frontend-lint:
  stage: lint
  image: node:${NODE_VERSION}
  cache:
    key: frontend-npm-cache
    paths:
      - frontend/node_modules/
  before_script:
    - cd frontend
    - npm ci
  script:
    - npm run lint
  only:
    - main
    - develop
    - merge_requests
    - /^feature\/.*$/

# ============================================
# BACKEND TESTS
# ============================================

backend-test:
  stage: test
  image: node:${NODE_VERSION}
  cache:
    key: backend-npm-cache
    paths:
      - backend/node_modules/
  before_script:
    - cd backend
    - npm ci
  script:
    - npm test
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    paths:
      - backend/coverage/
    expire_in: 7 days
  only:
    - main
    - develop
    - merge_requests
    - /^feature\/.*$/

# ============================================
# FRONTEND TESTS
# ============================================

frontend-test:
  stage: test
  image: node:${NODE_VERSION}
  cache:
    key: frontend-npm-cache
    paths:
      - frontend/node_modules/
  before_script:
    - cd frontend
    - npm ci
  script:
    - npm test
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    paths:
      - frontend/coverage/
    expire_in: 7 days
  only:
    - main
    - develop
    - merge_requests
    - /^feature\/.*$/

# ============================================
# BUILD FRONTEND
# ============================================

build-frontend:
  stage: build
  image: node:${NODE_VERSION}
  cache:
    key: frontend-npm-cache
    paths:
      - frontend/node_modules/
  dependencies:
    - backend-test
    - frontend-test
  before_script:
    - cd frontend
    - npm ci
  script:
    - npm run build
  artifacts:
    paths:
      - frontend/dist/
    expire_in: 7 days
  only:
    - main
    - develop
    - merge_requests
    - /^feature\/.*$/

# ============================================
# E2E TESTS
# ============================================

e2e-tests:
  stage: e2e
  image: node:${NODE_VERSION}
  services:
    - name: mcr.microsoft.com/playwright:v1.48.0-focal
      alias: playwright
  dependencies:
    - build-frontend
  before_script:
    - npm ci
    - cd backend && npm ci
    - cd ../frontend && npm ci
    - cd ..
    - npx playwright install --with-deps chromium firefox webkit
  script:
    # Start backend server in background
    - cd backend && npm start &
    - export BACKEND_PID=$!
    # Start frontend server in background
    - cd frontend && npm run dev &
    - export FRONTEND_PID=$!
    # Wait for servers to be ready
    - |
      echo "Waiting for backend server..."
      timeout 60 bash -c 'until curl -f http://localhost:3000/api/health; do sleep 2; done'
      echo "Waiting for frontend server..."
      timeout 60 bash -c 'until curl -f http://localhost:5173; do sleep 2; done'
    # Run E2E tests
    - npm run test:e2e
    # Cleanup
    - kill $BACKEND_PID || true
    - kill $FRONTEND_PID || true
  environment:
    name: test
    url: http://localhost:5173
  artifacts:
    when: always
    paths:
      - playwright-report/
    expire_in: 7 days
  only:
    - main
    - develop
    - merge_requests
    - /^feature\/.*$/

# ============================================
# DOCKER BUILD
# ============================================

docker-build-backend:
  stage: docker
  image: docker:24-dind
  services:
    - docker:24-dind
  dependencies:
    - e2e-tests
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY || echo "Docker login skipped"
  script:
    - |
      if [ -n "$CI_REGISTRY_USER" ]; then
        BACKEND_TAGS="$CI_REGISTRY_USER/bmi-app-backend:latest,$CI_REGISTRY_USER/bmi-app-backend:$CI_COMMIT_SHA"
        docker build -t $CI_REGISTRY_USER/bmi-app-backend:latest -t $CI_REGISTRY_USER/bmi-app-backend:$CI_COMMIT_SHA ./backend
        docker push $CI_REGISTRY_USER/bmi-app-backend:latest || echo "Push skipped"
        docker push $CI_REGISTRY_USER/bmi-app-backend:$CI_COMMIT_SHA || echo "Push skipped"
      else
        docker build -t bmi-app-backend:latest -t bmi-app-backend:$CI_COMMIT_SHA ./backend
      fi
  only:
    - main
    - develop

docker-build-frontend:
  stage: docker
  image: docker:24-dind
  services:
    - docker:24-dind
  dependencies:
    - e2e-tests
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY || echo "Docker login skipped"
  script:
    - |
      if [ -n "$CI_REGISTRY_USER" ]; then
        FRONTEND_TAGS="$CI_REGISTRY_USER/bmi-app-frontend:latest,$CI_REGISTRY_USER/bmi-app-frontend:$CI_COMMIT_SHA"
        docker build -t $CI_REGISTRY_USER/bmi-app-frontend:latest -t $CI_REGISTRY_USER/bmi-app-frontend:$CI_COMMIT_SHA ./frontend
        docker push $CI_REGISTRY_USER/bmi-app-frontend:latest || echo "Push skipped"
        docker push $CI_REGISTRY_USER/bmi-app-frontend:$CI_COMMIT_SHA || echo "Push skipped"
      else
        docker build -t bmi-app-frontend:latest -t bmi-app-frontend:$CI_COMMIT_SHA ./frontend
      fi
  only:
    - main
    - develop

# ============================================
# DEPLOY
# ============================================

deploy-staging:
  stage: deploy
  image: alpine:latest
  dependencies:
    - docker-build-backend
    - docker-build-frontend
  script:
    - echo "ðŸš€ Deploying to staging..."
    - echo "Add your deployment commands here"
    - echo "Example: kubectl apply -f k8s/staging/"
    - echo "Or: docker-compose -f docker-compose.staging.yml up -d"
  environment:
    name: staging
    url: https://staging.bmi-app.example.com
  only:
    - develop
  when: manual

deploy-production:
  stage: deploy
  image: alpine:latest
  dependencies:
    - docker-build-backend
    - docker-build-frontend
  script:
    - echo "ðŸš€ Deploying to production..."
    - echo "Add your deployment commands here"
    - echo "Example: kubectl apply -f k8s/production/"
    - echo "Or: docker-compose -f docker-compose.prod.yml up -d"
  environment:
    name: production
    url: https://bmi-app.example.com
  only:
    - main
  when: manual
